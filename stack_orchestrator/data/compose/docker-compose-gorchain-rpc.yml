services:
  agave-rpc:
    image: git.vdb.to/laconicnetwork/gorbagana/gorchain-rpc
    restart: unless-stopped
    hostname: agave-rpc
    labels:
      - "role=rpc"
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      # External validator is required
      VALIDATOR_ENTRYPOINT: ${VALIDATOR_ENTRYPOINT}
      KNOWN_VALIDATOR: ${KNOWN_VALIDATOR}
      RPC_PORT: ${RPC_PORT:-8899}
      GOSSIP_PORT: ${GOSSIP_PORT:-8001}
      DYNAMIC_PORT_RANGE: ${DYNAMIC_PORT_RANGE:-9000-9025}
      PUBLIC_RPC_ADDRESS: ${PUBLIC_RPC_ADDRESS}
      SNAPSHOT_INTERVAL_SLOTS: ${SNAPSHOT_INTERVAL_SLOTS:-200}
      MAXIMUM_SNAPSHOTS_TO_RETAIN: ${MAXIMUM_SNAPSHOTS_TO_RETAIN:-2}
      SOLANA_METRICS_CONFIG: ${SOLANA_METRICS_CONFIG}
      # Faucet address for requestAirdrop RPC (e.g., "127.0.0.1:9900")
      FAUCET_ADDRESS: ${FAUCET_ADDRESS:-}
    command: ["/opt/scripts/run.sh"]
    volumes:
      # Named volume for startup script - becomes ConfigMap in k8s
      - rpc-scripts-config:/opt/scripts:ro
      # Data volumes
      - rpc-config:/agave/config
      - rpc-ledger:/agave/ledger
      - rpc-accounts:/agave/accounts
    ports:
      # RPC ports
      - "8899"             # RPC HTTP
      - "8900"             # RPC WebSocket
      # Gossip port
      - "8001"             # Gossip TCP
      - "8001/udp"         # Gossip UDP
      # Dynamic port range for TPU/TVU/repair (9000-9025, 26 ports)
      - "9000/udp"
      - "9001/udp"
      - "9002/udp"
      - "9003/udp"
      - "9004/udp"
      - "9005/udp"
      - "9006/udp"
      - "9007/udp"
      - "9008/udp"
      - "9009/udp"
      - "9010/udp"
      - "9011/udp"
      - "9012/udp"
      - "9013/udp"
      - "9014/udp"
      - "9015/udp"
      - "9016/udp"
      - "9017/udp"
      - "9018/udp"
      - "9019/udp"
      - "9020/udp"
      - "9021/udp"
      - "9022/udp"
      - "9023/udp"
      - "9024/udp"
      - "9025/udp"
    ulimits:
      nofile:
        soft: 1000000
        hard: 1000000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${RPC_PORT:-8899}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    extra_hosts:
      influxdb: 127.0.0.1

volumes:
  # Config volume - will become ConfigMap in k8s (contains "config" in name)
  rpc-scripts-config:
  # Data volumes - will become PVCs in k8s
  rpc-config:
  rpc-ledger:
  rpc-accounts:
