services:
  agave-rpc:
    image: git.vdb.to/laconicnetwork/gorbagana/gorchain-rpc
    restart: unless-stopped
    hostname: agave-rpc
    labels:
      - "role=rpc"
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      # External validator is required
      VALIDATOR_ENTRYPOINT: ${VALIDATOR_ENTRYPOINT}
      KNOWN_VALIDATOR: ${KNOWN_VALIDATOR}
      RPC_PORT: ${RPC_PORT:-8899}
      GOSSIP_PORT: ${GOSSIP_PORT:-8001}
      DYNAMIC_PORT_RANGE: ${DYNAMIC_PORT_RANGE:-9000-9025}
      PUBLIC_RPC_ADDRESS: ${PUBLIC_RPC_ADDRESS}
      SNAPSHOT_INTERVAL_SLOTS: ${SNAPSHOT_INTERVAL_SLOTS:-200}
      MAXIMUM_SNAPSHOTS_TO_RETAIN: ${MAXIMUM_SNAPSHOTS_TO_RETAIN:-2}
      SOLANA_METRICS_CONFIG: ${SOLANA_METRICS_CONFIG}
      # Faucet address for requestAirdrop RPC (e.g., "127.0.0.1:9900")
      FAUCET_ADDRESS: ${FAUCET_ADDRESS:-}
    command: ["/opt/scripts/run.sh"]
    volumes:
      # Named volume for startup script - becomes ConfigMap in k8s
      - rpc-scripts-config:/opt/scripts:ro
      # Data volumes
      - rpc-config:/agave/config
      - rpc-ledger:/agave/ledger
      - rpc-accounts:/agave/accounts
    ports:
      - "${RPC_PORT:-8899}"             # RPC
      - "${RPC_WS_PORT:-8900}"          # RPC pubsub
      - "${GOSSIP_PORT:-8001}"          # Gossip
      - "${GOSSIP_PORT:-8001}/udp"      # Gossip
      - "${DYNAMIC_PORT_RANGE:-9000-9025}/udp"     # Dynamically assigned ports
    ulimits:
      nofile:
        soft: 1000000
        hard: 1000000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${RPC_PORT:-8899}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    extra_hosts:
      influxdb: 127.0.0.1

volumes:
  # Config volume - will become ConfigMap in k8s (contains "config" in name)
  rpc-scripts-config:
  # Data volumes - will become PVCs in k8s
  rpc-config:
  rpc-ledger:
  rpc-accounts:
