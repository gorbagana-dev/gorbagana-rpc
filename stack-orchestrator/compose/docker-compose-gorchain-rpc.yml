services:
  agave-rpc:
    image: git.vdb.to/laconicnetwork/gorbagana/gorchain-rpc
    restart: unless-stopped
    hostname: agave-rpc
    labels:
      - "role=rpc"
    environment:
      RUST_LOG: ${RUST_LOG:-info}
      # External validator is required
      VALIDATOR_ENTRYPOINT: ${VALIDATOR_ENTRYPOINT}
      KNOWN_VALIDATOR: ${KNOWN_VALIDATOR}
      RPC_PORT: ${RPC_PORT:-8899}
      GOSSIP_PORT: ${GOSSIP_PORT:-8001}
      DYNAMIC_PORT_RANGE: ${DYNAMIC_PORT_RANGE:-9000-9025}
      PUBLIC_RPC_ADDRESS: ${PUBLIC_RPC_ADDRESS}
      SNAPSHOT_INTERVAL_SLOTS: ${SNAPSHOT_INTERVAL_SLOTS:-200}
      MAXIMUM_SNAPSHOTS_TO_RETAIN: ${MAXIMUM_SNAPSHOTS_TO_RETAIN:-2}
      SOLANA_METRICS_CONFIG: ${SOLANA_METRICS_CONFIG}
      # Faucet address for requestAirdrop RPC (e.g., "127.0.0.1:9900")
      FAUCET_ADDRESS: ${FAUCET_ADDRESS:-}
    command: ["/opt/run.sh"]
    volumes:
      - ../config/gorchain/start-rpc.sh:/opt/run.sh
      - rpc_config:/agave/config
      - rpc_ledger:/agave/ledger
      - rpc_accounts:/agave/accounts
    ports:
      - "127.0.0.1:${RPC_PORT}:${RPC_PORT:-8899}"             # RPC
      - "127.0.0.1:${RPC_WS_PORT}:${RPC_WS_PORT:-8900}"       # RPC pubsub
      - "${GOSSIP_PORT:-8001}:${GOSSIP_PORT:-8001}/tcp"       # Gossip
      - "${GOSSIP_PORT:-8001}:${GOSSIP_PORT:-8001}/udp"       # Gossip
      - "${DYNAMIC_PORT_RANGE:-9000-9025}:${DYNAMIC_PORT_RANGE:-9000-9025}/udp" # Dynamically assigned ports
    ulimits:
      nofile:
        soft: 1000000
        hard: 1000000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${RPC_PORT:-8899}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    extra_hosts:
      # For convenience and documentation
      influxdb: 127.0.0.1

  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    hostname: caddy
    entrypoint: ["/scripts/caddy-entrypoint.sh"]
    depends_on:
      agave-rpc:
        condition: service_healthy
    environment:
      DOMAIN: ${CADDY_DOMAIN:-localhost}
      TLS_CONFIG: ${CADDY_TLS_CONFIG-tls internal} # using "-" instead of ":-" to allow empty string
      ACME_EMAIL: ${CADDY_ACME_EMAIL:+email ${CADDY_ACME_EMAIL}}
      ACME_CA: ${CADDY_ACME_CA:+acme_ca ${CADDY_ACME_CA}}
      LOG_LEVEL: ${CADDY_LOG_LEVEL:-INFO}
      RPC_BACKEND: agave-rpc:${RPC_PORT:-8899}
      WS_BACKEND: agave-rpc:${RPC_WS_PORT:-8900}
      API_AUTH_ENABLED: ${CADDY_API_AUTH_ENABLED:-false}
    volumes:
      - ../config/gorchain/caddy-entrypoint.sh:/scripts/caddy-entrypoint.sh:ro
      - ../config/gorchain/manage-keys.sh:/scripts/manage-keys.sh:ro
      - ../config/gorchain/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"

  restarter:
    image: gorbagana/gorchain-restarter:local
    restart: unless-stopped
    depends_on:
      - agave-rpc
    command: ["/cron/restart.cron"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../config/gorchain/restart.cron:/cron/restart.cron:ro
      - ../config/gorchain/restart-node.sh:/scripts/restart-node.sh:ro

volumes:
  rpc_config:
  rpc_ledger:
  rpc_accounts:
  caddy_data:
  caddy_config:
